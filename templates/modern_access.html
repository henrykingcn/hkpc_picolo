<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKPC Access Control</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern_access.css') }}">
</head>
<body>
    <!-- å…¨å±è§†é¢‘ -->
    <div class="video-container">
        <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Camera Feed">
    </div>
    
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
        <img src="{{ url_for('static', filename='images/logo-hkpc.png') }}" alt="HKPC" class="logo">
        <span class="system-title">Access Control System</span>
    </div>
    
    <!-- éšè—ç®¡ç†æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ -->
    <button class="admin-btn" onclick="window.location.href='/admin/login'" title="Admin Panel">âš™ï¸</button>
    
    <!-- è¿·ä½ PPEæŒ‡ç¤ºå™¨ -->
    <div class="ppe-indicator">
        <svg class="ppe-mini-icon" viewBox="0 0 100 200" id="mini-body-svg">
            <!-- è¶…ç®€åŒ–äººä½“ -->
            <circle id="mini-head" cx="50" cy="20" r="15" fill="#666" stroke="#333" stroke-width="2"/>
            <rect id="mini-body" x="35" y="35" width="30" height="50" rx="5" fill="#666" stroke="#333" stroke-width="2"/>
            <circle id="mini-hand-l" cx="25" cy="60" r="8" fill="#666" stroke="#333" stroke-width="2"/>
            <circle id="mini-hand-r" cx="75" cy="60" r="8" fill="#666" stroke="#333" stroke-width="2"/>
            <rect id="mini-leg-l" x="38" y="85" width="10" height="30" rx="3" fill="#666" stroke="#333" stroke-width="2"/>
            <rect id="mini-leg-r" x="52" y="85" width="10" height="30" rx="3" fill="#666" stroke="#333" stroke-width="2"/>
        </svg>
        <div class="ppe-items" id="ppe-items"></div>
    </div>
    
    <!-- æ—¶é—´ä¿¡æ¯ -->
    <div class="info-badge">
        <div class="info-item">
            <span>â°</span>
            <span id="time">--:--:--</span>
        </div>
        <div class="info-item">
            <span>ğŸ“…</span>
            <span id="date">----/--/--</span>
        </div>
    </div>
    
    <!-- ä¸»çŠ¶æ€æ˜¾ç¤º -->
    <div class="status-overlay" id="status-overlay">
        <div class="status-icon pulse" id="status-icon">ğŸ‘‹</div>
        <div class="status-text" id="status-text">GOOD MORNING</div>
        <div class="status-message" id="status-msg">Please stand in front of camera</div>
        <div class="progress-bar" id="progress-bar" style="display: none;">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // ç®€åŒ–ç‰ˆæ£€æµ‹æ›´æ–°
        const socket = io();
        let required = ['Head', 'Hands'];
        let detected = [];
        let lastAccessGranted = false;
        let accessGrantedStartTime = null;  // è®°å½•æˆæƒå¼€å§‹æ—¶é—´
        let isInGrantedState = false;  // æ˜¯å¦å¤„äºæˆæƒçŠ¶æ€
        
        // è·å–é—®å€™è¯­
        function getGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) return 'Good Morning';
            if (hour < 18) return 'Good Afternoon';
            return 'Good Evening';
        }
        
        // TTSè¯­éŸ³æ’­æŠ¥
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                speechSynthesis.speak(utterance);
            }
        }
        
        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            document.getElementById('time').textContent = now.toLocaleTimeString('en-US', {hour12: false});
            document.getElementById('date').textContent = now.toLocaleDateString('en-US');
        }
        updateTime();
        setInterval(updateTime, 1000);
        
        // åˆå§‹åŒ–æ˜¾ç¤ºé—®å€™è¯­
        document.getElementById('status-text').textContent = getGreeting().toUpperCase();
        
        // æ›´æ–°äººä½“é¢œè‰²ï¼ˆæ ¹æ®é…ç½®ï¼‰
        function updateBody(detectedClasses) {
            const detectedLower = detectedClasses.map(c => c.toLowerCase());
            const requiredLower = required.map(c => c.toLowerCase());
            
            // æ£€æŸ¥å¤´éƒ¨ç›¸å…³
            const headRequired = requiredLower.some(r => ['head', 'helmet', 'face-mask-medical'].includes(r));
            const headDetected = detectedLower.some(d => ['head', 'helmet', 'face', 'face-mask-medical'].includes(d));
            
            // æ£€æŸ¥æ‰‹éƒ¨ç›¸å…³
            const handsRequired = requiredLower.some(r => ['hands', 'gloves'].includes(r));
            const handsDetected = detectedLower.some(d => ['hands', 'gloves'].includes(d));
            
            // æ ¹æ®æ˜¯å¦éœ€è¦å’Œæ˜¯å¦æ£€æµ‹åˆ°æ¥è®¾ç½®é¢œè‰²
            document.getElementById('mini-head').style.fill = 
                headRequired ? (headDetected ? '#10B981' : '#EF4444') : '#666';
            document.getElementById('mini-hand-l').style.fill = 
                handsRequired ? (handsDetected ? '#10B981' : '#EF4444') : '#666';
            document.getElementById('mini-hand-r').style.fill = 
                handsRequired ? (handsDetected ? '#10B981' : '#EF4444') : '#666';
            
            document.getElementById('mini-body').style.fill = '#666';
            document.getElementById('mini-leg-l').style.fill = '#666';
            document.getElementById('mini-leg-r').style.fill = '#666';
        }
        
        // æ›´æ–°PPEåˆ—è¡¨
        function updatePPEList(detectedClasses) {
            const list = document.getElementById('ppe-items');
            list.innerHTML = required.map(item => {
                const isDetected = detectedClasses.some(c => c.toLowerCase() === item.toLowerCase());
                return `<div class="ppe-mini-item ${isDetected ? 'detected' : 'missing'}">
                    <span>${item}</span>
                    <span>${isDetected ? 'âœ“' : 'âœ—'}</span>
                </div>`;
            }).join('');
        }
        
        // æ£€æŸ¥PPEæ˜¯å¦å®Œæ•´
        function checkPPEComplete(detectedClasses, requiredClasses) {
            // è½¬æ¢ä¸ºå°å†™è¿›è¡Œæ¯”è¾ƒ
            const detectedLower = detectedClasses.map(c => c.toLowerCase());
            const requiredLower = requiredClasses.map(c => c.toLowerCase());
            
            // æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„PPEæ˜¯å¦éƒ½è¢«æ£€æµ‹åˆ°
            return requiredLower.every(req => detectedLower.includes(req));
        }
        
        // è·å–ç¼ºå¤±çš„PPE
        function getMissingPPE(detectedClasses, requiredClasses) {
            const detectedLower = detectedClasses.map(c => c.toLowerCase());
            const requiredLower = requiredClasses.map(c => c.toLowerCase());
            
            return requiredClasses.filter((req, i) => !detectedLower.includes(requiredLower[i]));
        }
        
        // WebSocketäº‹ä»¶
        socket.on('detection_update', (data) => {
            detected = data.detected_classes || [];
            updateBody(detected);
            updatePPEList(detected);
            
            // åªæ›´æ–°æ£€æµ‹çŠ¶æ€ï¼Œä¸è‡ªå·±åˆ¤æ–­æ˜¯å¦æ”¾è¡Œ
            // è®¿é—®å†³ç­–ç”±åç«¯çš„ access_status_change äº‹ä»¶æ§åˆ¶
            const missing = getMissingPPE(detected, required);
            
            console.log('ğŸ” Detection update:', {
                detected: detected,
                required: required,
                missing: missing
            });
        });
        
        // ç›‘å¬åç«¯çš„è®¿é—®æ§åˆ¶å†³ç­–ï¼ˆè¿™æ‰æ˜¯çœŸæ­£çš„å†³ç­–ï¼‰
        socket.on('access_status_change', (data) => {
            console.log('ğŸ¯ Access status from backend:', data);
            
            const overlay = document.getElementById('status-overlay');
            const icon = document.getElementById('status-icon');
            const text = document.getElementById('status-text');
            const msg = document.getElementById('status-msg');
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            
            const state = data.state;
            const missing = getMissingPPE(detected, required);
            
            if (state === 'ACCESS_GRANTED') {
                // æˆæƒï¼åç«¯å·²æ‰¹å‡†
                isInGrantedState = true;
                overlay.className = 'status-overlay granted slide-up';
                icon.textContent = 'âœ…';
                text.textContent = 'ACCESS GRANTED';
                msg.textContent = data.person_name ? `Welcome ${data.person_name}!` : 'Welcome! Door opening...';
                
                // TTS è¯­éŸ³æ’­æŠ¥
                const greeting = getGreeting();
                speak(`${greeting}, Please come in`);
                
                // æ˜¾ç¤ºè¿›åº¦æ¡
                progressBar.style.display = 'block';
                progressFill.style.width = '0%';
                setTimeout(() => {
                    progressFill.style.width = '100%';
                }, 100);
                
            } else if (state === 'ACCESS_DENIED') {
                // æ‹’ç»è®¿é—®ï¼åç«¯å·²æ‹’ç»
                isInGrantedState = false;
                overlay.className = 'status-overlay denied shake';
                icon.textContent = 'âŒ';
                text.textContent = 'ACCESS DENIED';
                msg.textContent = data.message || 'Access not authorized';
                progressBar.style.display = 'none';
                
            } else if (state === 'IDLE') {
                // ç©ºé—²çŠ¶æ€
                isInGrantedState = false;
                overlay.className = 'status-overlay';
                icon.textContent = 'ğŸ‘‹';
                text.textContent = getGreeting().toUpperCase();
                msg.textContent = 'Please stand in front of camera';
                progressBar.style.display = 'none';
                
            } else if (state === 'FACE_DETECTING') {
                // æ­£åœ¨æ£€æµ‹äººè„¸
                overlay.className = 'status-overlay checking';
                icon.textContent = 'ğŸ‘¤';
                text.textContent = 'DETECTING FACE';
                msg.textContent = 'Please look at the camera...';
                progressBar.style.display = 'none';
                
            } else if (state === 'PPE_CHECKING') {
                // æ­£åœ¨æ£€æµ‹ PPE
                overlay.className = 'status-overlay checking';
                icon.textContent = 'ğŸ”';
                text.textContent = 'CHECKING PPE';
                
                if (missing.length > 0) {
                    msg.textContent = `Missing: ${missing.join(', ')}`;
                } else {
                    msg.textContent = 'Verifying equipment...';
                }
                progressBar.style.display = 'none';
            }
        });
        
        socket.on('connect', () => {
            console.log('âœ… Connected to server');
            socket.emit('request_config');
            // è¿æ¥æˆåŠŸåå¯åŠ¨æ£€æµ‹
            socket.emit('start_detection');
            console.log('ğŸ¬ Starting detection...');
        });
        
        socket.on('disconnect', () => {
            console.log('âŒ Disconnected from server');
        });
        
        socket.on('config_update', (data) => {
            required = data.required_classes || ['Head', 'Hands'];
            console.log('âœ… é…ç½®æ›´æ–°:', required);
        });
        
        socket.on('detection_started', (data) => {
            console.log('âœ… Detection started:', data);
        });
        
        socket.on('detection_stopped', (data) => {
            console.log('â¹ï¸ Detection stopped:', data);
        });
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³è¯·æ±‚é…ç½®
        setTimeout(() => {
            socket.emit('request_config');
        }, 500);
        
        // é¡µé¢å³å°†å…³é—­æˆ–ç¦»å¼€æ—¶åœæ­¢æ£€æµ‹
        window.addEventListener('beforeunload', function(event) {
            console.log('ğŸ“´ Page closing/leaving, stopping detection...');
            socket.emit('stop_detection');
        });
        
        // é¡µé¢å¸è½½æ—¶ä¹Ÿåœæ­¢ï¼ˆå¤‡ç”¨ï¼‰
        window.addEventListener('unload', function() {
            console.log('ğŸ“´ Page unloaded, stopping detection...');
            socket.emit('stop_detection');
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æ§åˆ¶æ£€æµ‹ï¼ˆåˆ‡æ¢æ ‡ç­¾é¡µï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('ğŸ‘ï¸ Page hidden (tab switched), stopping detection...');
                socket.emit('stop_detection');
            } else {
                console.log('ğŸ‘ï¸ Page visible (tab back), restarting detection...');
                socket.emit('start_detection');
            }
        });
        
        // é¡µé¢å¤±å»ç„¦ç‚¹æ—¶åœæ­¢æ£€æµ‹ï¼ˆå¯¼èˆªåˆ°å…¶ä»–é¡µé¢ï¼‰
        window.addEventListener('pagehide', function() {
            console.log('ğŸ“´ Page hidden (navigation), stopping detection...');
            socket.emit('stop_detection');
        });
    </script>
</body>
</html>

